<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Chamados TI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .new-ticket-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .new-ticket-button:hover {
            background: #f8f9fa;
            transform: scale(1.1);
        }

        .new-ticket-form {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 400px;
            height: auto;
            max-height: calc(100vh - 130px);
            overflow-y: auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 999;
            transform: scale(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease;
        }

        .new-ticket-form.active {
            transform: scale(1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .channels {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .channel-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .channel-checkbox input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            opacity: 0.8;
        }

        .tickets-container {
            margin: 0 auto;
            max-width: 95%;
            min-height: 140px;
        }
        
        .section-container {
            background: white;
            border-radius: 8px;
            overflow-x: auto;
            overflow-y: visible;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .tickets-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            min-width: 1200px;
        }
        
        .tickets-table th:nth-child(1) { width: 120px; } /* Chamado */
        .tickets-table th:nth-child(2) { width: 150px; } /* Cliente */
        .tickets-table th:nth-child(3) { width: 100px; } /* Status */
        .tickets-table th:nth-child(4) { width: 200px; } /* Descrição */
        .tickets-table th:nth-child(5) { width: 120px; } /* Canais */
        .tickets-table th:nth-child(6) { width: 150px; } /* Timer */
        .tickets-table th:nth-child(7) { width: 220px; } /* Ações */

        .tickets-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: #333;
            border-bottom: 2px solid #e9ecef;
        }

        .tickets-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.75rem;
            vertical-align: middle;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tickets-table td:nth-child(4) {
            white-space: normal;
            line-height: 1.3;
        }

        .tickets-table tr:hover {
            background: #f8f9fa;
        }

        .tickets-table tr.alert:hover {
            background: #ffcdd2 !important;
        }

        .group-header {
            background: #e3f2fd !important;
            font-weight: bold;
            text-align: center;
            padding: 12px 8px;
            color: #1565c0;
            border-bottom: 2px solid #bbdefb;
            border-top: 3px solid #1976d2;
        }

        .group-header td {
            background: #e3f2fd !important;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .group-header:first-of-type {
            border-top: none;
        }

        .ticket-row {
            border-left: 3px solid #e0e0e0;
        }

        .ticket:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #f5f5f5;
        }

        .ticket-number {
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
        }

        .ticket-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-novo {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-contato1, .status-contato2, .status-contato3 {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-atendendo {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-pausado {
            background: #fce4ec;
            color: #c2185b;
        }

        .status-agendado {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-fornecedor {
            background: #e0f2f1;
            color: #00796b;
        }

        .status-acompanhamento {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .bloqueio-constante-badge {
            background: #ff5722;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: bold;
            margin-left: 5px;
        }

        .ticket-info {
            margin-bottom: 6px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .ticket-info-item {
            min-width: 0;
        }

        .ticket-info-item p {
            margin: 1px 0;
            color: #666;
            font-size: 0.75rem;
            line-height: 1.2;
        }

        .ticket-info-item strong {
            color: #333;
        }

        .ticket-timer {
            background: #f8f9fa;
            padding: 4px 6px;
            border-radius: 3px;
            margin-bottom: 6px;
            text-align: center;
        }

        .timer-text {
            font-size: 0.7rem;
            font-weight: 600;
            color: #333;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .alert {
            background: #ffebee !important;
            color: #c62828;
        }

        .alert td {
            background: #ffebee;
            color: #c62828;
        }

        .alert .ticket-number {
            color: #d32f2f;
            font-weight: bold;
        }

        .alert .ticket-number {
            color: #ff4444;
            font-weight: bold;
        }


        .ticket-actions button {
            padding: 4px 8px;
            font-size: 0.65rem;
            border-radius: 4px;
            min-width: 55px;
            white-space: nowrap;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-secondary {
            background: #757575;
        }

        .btn-success {
            background: #4caf50;
        }

        .btn-warning {
            background: #ff9800;
        }

        .btn-danger {
            background: #f44336;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .notification p {
            color: #666;
            margin-bottom: 15px;
        }

        .notification button {
            padding: 8px 20px;
            font-size: 14px;
        }

        .stats {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            height: 140px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .schedule-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .schedule-modal.active {
            display: flex;
        }

        .schedule-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .schedule-modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .schedule-modal .form-group {
            margin-bottom: 20px;
        }

        .schedule-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .edit-modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .edit-modal .form-group {
            margin-bottom: 20px;
        }

        .edit-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .edit-channels {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .edit-channel-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-channel-checkbox input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .btn-edit {
            background: #6c757d;
            color: white;
            order: 999;
        }

        .btn-edit:hover {
            background: #495057;
        }

        .btn-delete {
            background: #ff0000;
            color: white;
            border: none;
            padding: 2px 4px;
            font-size: 0.7rem;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 8px;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }

        .btn-delete:hover {
            background: #cc0000;
        }

        .ticket-actions {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            min-height: 30px;
            width: 100%;
        }

        @media (max-width: 1024px) {
            .new-ticket-form {
                width: 350px;
                right: 20px;
                max-height: calc(100vh - 100px);
            }
        }
        
        @media (max-width: 768px) {
            .ticket-info {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            
            .ticket-actions {
                gap: 3px;
            }
            
            .ticket-actions button {
                min-width: 60px;
                padding: 3px 6px;
                font-size: 0.65rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .new-ticket-form {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
                max-height: calc(100vh - 80px);
            }
        }

        footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
            font-size: 0.9rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>🎫 Controle de Chamados de TI</h1>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalTickets">0</div>
                <div class="stat-label">Total de Chamados</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="activeTickets">0</div>
                <div class="stat-label">Em Atendimento</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="pausedTickets">0</div>
                <div class="stat-label">Pausados</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="scheduledTickets">0</div>
                <div class="stat-label">Agendados</div>
            </div>
        </div>

        <button class="new-ticket-button" onclick="toggleNewTicketForm()" title="Novo Chamado">
            <span id="newTicketIcon">+</span>
        </button>
        
        <div class="new-ticket-form" id="newTicketForm">
            <h2 style="margin-bottom: 20px; color: #333;">Novo Chamado</h2>
            <div class="form-group">
                <label for="ticketNumber">Número do Chamado:</label>
                <input type="text" id="ticketNumber" placeholder="Ex: TI-2024-001">
            </div>
            
            <div class="form-group">
                <label for="clientName">Nome do Cliente:</label>
                <input type="text" id="clientName" placeholder="Nome do solicitante">
            </div>
            
            <div class="form-group">
                <label for="ticketLink">Link do Chamado (opcional):</label>
                <input type="url" id="ticketLink" placeholder="https://exemplo.com/chamado/123">
            </div>
            
            <div class="form-group">
                <label for="description">Descrição:</label>
                <textarea id="description" rows="3" placeholder="Breve descrição do problema"></textarea>
            </div>
            
            <div class="form-group">
                <div class="channel-checkbox">
                    <input type="checkbox" id="bloqueioConstante">
                    <label for="bloqueioConstante">Bloqueio Constante</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Canais de Contato Disponíveis:</label>
                <div class="channels">
                    <div class="channel-checkbox">
                        <input type="checkbox" id="whatsapp" checked>
                        <label for="whatsapp"><img src="icons/whatsapp.png" alt="WhatsApp" style="width: 20px; height: 20px;"></label>
                    </div>
                    <div class="channel-checkbox">
                        <input type="checkbox" id="slack" checked>
                        <label for="slack"><img src="icons/slack.png" alt="Slack" style="width: 20px; height: 20px;"></label>
                    </div>
                    <div class="channel-checkbox">
                        <input type="checkbox" id="googlechat" checked>
                        <label for="googlechat"><img src="icons/google-chat.png" alt="Google Chat" style="width: 20px; height: 20px;"></label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="ticketType">Tipo de Chamado:</label>
                <select id="ticketType">
                    <option value="normal">Normal</option>
                    <option value="scheduled">Agendado</option>
                </select>
            </div>
            
            <div class="form-group" id="scheduleGroup" style="display: none;">
                <label for="scheduleDateTime">Data e Hora do Agendamento:</label>
                <input type="datetime-local" id="scheduleDateTime">
            </div>
            
            <div class="form-group">
                <label for="waitTime">Tempo de espera entre contatos (minutos):</label>
                <input type="number" id="waitTime" value="30" min="1" max="1440" style="width: 150px;">
            </div>
            
            <button onclick="addTicket()">Adicionar Chamado</button>
        </div>

        <div class="tickets-container" id="ticketsContainer"></div>
    </div>

    <div class="schedule-modal" id="scheduleModal">
        <div class="schedule-modal-content">
            <h3>📅 Agendar Atendimento</h3>
            <div class="form-group">
                <label for="modalScheduleDateTime">Data e Hora:</label>
                <input type="datetime-local" id="modalScheduleDateTime">
            </div>
            <div class="form-group">
                <label for="modalScheduleNotes">Observações (opcional):</label>
                <textarea id="modalScheduleNotes" rows="3" placeholder="Anotações sobre o agendamento"></textarea>
            </div>
            <div class="schedule-modal-buttons">
                <button class="btn-secondary" onclick="closeScheduleModal()">Cancelar</button>
                <button onclick="confirmSchedule()">Confirmar Agendamento</button>
            </div>
        </div>
    </div>

    <div class="edit-modal" id="editModal">
        <div class="edit-modal-content">
            <h3>✏️ Editar Chamado</h3>
            <div class="form-group">
                <label for="editTicketNumber">Número do Chamado:</label>
                <input type="text" id="editTicketNumber" placeholder="Ex: TI-2024-001">
            </div>
            
            <div class="form-group">
                <label for="editClientName">Nome do Cliente:</label>
                <input type="text" id="editClientName" placeholder="Nome do solicitante">
            </div>
            
            <div class="form-group">
                <label for="editDescription">Descrição:</label>
                <textarea id="editDescription" rows="3" placeholder="Breve descrição do problema"></textarea>
            </div>
            
            <div class="form-group">
                <label>Canais de Contato Disponíveis:</label>
                <div class="edit-channels">
                    <div class="edit-channel-checkbox">
                        <input type="checkbox" id="editWhatsapp">
                        <label for="editWhatsapp"><img src="icons/whatsapp.png" alt="WhatsApp" style="width: 20px; height: 20px;"></label>
                    </div>
                    <div class="edit-channel-checkbox">
                        <input type="checkbox" id="editSlack">
                        <label for="editSlack"><img src="icons/slack.png" alt="Slack" style="width: 20px; height: 20px;"></label>
                    </div>
                    <div class="edit-channel-checkbox">
                        <input type="checkbox" id="editGooglechat">
                        <label for="editGooglechat"><img src="icons/google-chat.png" alt="Google Chat" style="width: 20px; height: 20px;"></label>
                    </div>
                </div>
            </div>
            
            <div class="edit-modal-buttons">
                <button class="btn-secondary" onclick="closeEditModal()">Cancelar</button>
                <button onclick="confirmEdit()">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <audio id="alertSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTG" type="audio/wav">
    </audio>

    <script>
        let tickets = [];
        let timers = {};
        let currentSchedulingTicket = null;
        let currentEditingTicket = null;
        let alertedTickets = new Set();
        let alertBeepInterval = null;
        
        // Carregar dados salvos
        function loadData() {
            const saved = localStorage.getItem('tickets');
            if (saved) {
                tickets = JSON.parse(saved);
                tickets.forEach(ticket => {
                    if (ticket.status !== 'fechado') {
                        startTimer(ticket);
                    }
                });
                updateDisplay();
            }
        }
        
        // Salvar dados
        function saveData() {
            localStorage.setItem('tickets', JSON.stringify(tickets));
        }
        
        // Tocar som de alerta
        function playAlert() {
            const audio = document.getElementById('alertSound');
            audio.play().catch(e => {
                // Fallback para beep usando Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            });
        }
        
        // Iniciar alerta contínuo
        function startContinuousAlert() {
            if (alertBeepInterval) return; // Já está tocando
            
            playAlert();
            alertBeepInterval = setInterval(() => {
                // Verificar se ainda há tickets em alerta
                const hasAlerts = tickets.some(ticket => {
                    if (ticket.status === 'fechado') return false;
                    const now = new Date();
                    const lastAction = new Date(ticket.lastAction);
                    const diffMinutes = Math.floor((now - lastAction) / 1000 / 60);
                    const waitTime = ticket.waitTime || 30;
                    return (ticket.status === 'novo' && diffMinutes >= waitTime) ||
                           (ticket.status.startsWith('contato') && diffMinutes >= waitTime);
                });
                
                if (hasAlerts) {
                    playAlert();
                } else {
                    stopContinuousAlert();
                }
            }, 3000); // Beep a cada 3 segundos
        }
        
        // Parar alerta contínuo
        function stopContinuousAlert() {
            if (alertBeepInterval) {
                clearInterval(alertBeepInterval);
                alertBeepInterval = null;
            }
        }
        
        // Mostrar notificação
        function showNotification(title, message, ticketId) {
            // Prevent duplicate alerts for the same ticket
            const alertKey = `${ticketId}-${title}`;
            if (alertedTickets.has(alertKey)) {
                return;
            }
            alertedTickets.add(alertKey);
            
            startContinuousAlert();
            
            // Notificação do navegador
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '🎫',
                    requireInteraction: true
                });
            }
            
            // Notificação na tela
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <h3>⚠️ ${title}</h3>
                <p>${message}</p>
                <button onclick="acknowledgeAlert('${ticketId}'); this.parentElement.remove()">OK</button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
        
        // Solicitar permissão para notificações
        if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission();
        }
        
        // Adicionar novo chamado
        function addTicket() {
            const ticketNumber = document.getElementById('ticketNumber').value;
            const clientName = document.getElementById('clientName').value;
            const ticketLink = document.getElementById('ticketLink').value;
            const description = document.getElementById('description').value;
            const ticketType = document.getElementById('ticketType').value;
            const waitTime = parseInt(document.getElementById('waitTime').value) || 30;
            const bloqueioConstante = document.getElementById('bloqueioConstante').checked;
            
            if (!ticketNumber || !clientName) {
                alert('Preencha o número do chamado e nome do cliente!');
                return;
            }
            
            const channels = [];
            if (document.getElementById('whatsapp').checked) channels.push('<img src="icons/whatsapp.png" alt="WhatsApp" style="width: 14px; height: 14px;">');
            if (document.getElementById('slack').checked) channels.push('<img src="icons/slack.png" alt="Slack" style="width: 14px; height: 14px;">');
            if (document.getElementById('googlechat').checked) channels.push('<img src="icons/google-chat.png" alt="Google Chat" style="width: 14px; height: 14px;">');
            
            if (channels.length === 0) {
                alert('Selecione pelo menos um canal de contato!');
                return;
            }
            
            const ticket = {
                id: Date.now().toString(),
                number: ticketNumber,
                client: clientName,
                link: ticketLink,
                description: description,
                channels: channels,
                currentChannel: 0,
                status: ticketType === 'scheduled' ? 'agendado' : 'novo',
                createdAt: new Date().toISOString(),
                lastAction: new Date().toISOString(),
                type: ticketType,
                scheduledFor: ticketType === 'scheduled' ? document.getElementById('scheduleDateTime').value : null,
                pausedAt: null,
                contactAttempts: 0,
                scheduleNotes: '',
                waitTime: waitTime,
                bloqueioConstante: bloqueioConstante,
                fixedAt: null,
                followUpDays: 0
            };
            
            tickets.push(ticket);
            saveData();
            startTimer(ticket);
            updateDisplay();
            
            // Limpar formulário
            document.getElementById('ticketNumber').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('ticketLink').value = '';
            document.getElementById('description').value = '';
            document.getElementById('whatsapp').checked = true;
            document.getElementById('slack').checked = true;
            document.getElementById('googlechat').checked = true;
            document.getElementById('ticketType').value = 'normal';
            document.getElementById('scheduleGroup').style.display = 'none';
            document.getElementById('waitTime').value = '30';
            document.getElementById('bloqueioConstante').checked = false;
            
            // Fechar formulário após adicionar
            toggleNewTicketForm();
        }
        
        // Abrir modal de agendamento
        function openScheduleModal(ticketId) {
            currentSchedulingTicket = ticketId;
            const modal = document.getElementById('scheduleModal');
            modal.classList.add('active');
            
            // Definir data/hora mínima como agora
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('modalScheduleDateTime').min = now.toISOString().slice(0, 16);
            document.getElementById('modalScheduleDateTime').value = '';
            document.getElementById('modalScheduleNotes').value = '';
        }
        
        // Fechar modal de agendamento
        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
            currentSchedulingTicket = null;
        }
        
        // Confirmar agendamento
        function confirmSchedule() {
            const ticket = tickets.find(t => t.id === currentSchedulingTicket);
            if (!ticket) return;
            
            const scheduleDateTime = document.getElementById('modalScheduleDateTime').value;
            const scheduleNotes = document.getElementById('modalScheduleNotes').value;
            
            if (!scheduleDateTime) {
                alert('Selecione uma data e hora para o agendamento!');
                return;
            }
            
            ticket.status = 'agendado';
            ticket.scheduledFor = scheduleDateTime;
            ticket.scheduleNotes = scheduleNotes;
            ticket.lastAction = new Date().toISOString();
            
            saveData();
            updateDisplay();
            closeScheduleModal();
        }
        
        // Abrir modal de edição
        function openEditModal(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            currentEditingTicket = ticketId;
            
            // Preencher campos com dados atuais
            document.getElementById('editTicketNumber').value = ticket.number;
            document.getElementById('editClientName').value = ticket.client;
            document.getElementById('editDescription').value = ticket.description || '';
            
            // Marcar canais selecionados
            const hasWhatsapp = ticket.channels.some(channel => channel.includes('whatsapp'));
            const hasSlack = ticket.channels.some(channel => channel.includes('slack'));
            const hasGooglechat = ticket.channels.some(channel => channel.includes('google-chat'));
            
            document.getElementById('editWhatsapp').checked = hasWhatsapp;
            document.getElementById('editSlack').checked = hasSlack;
            document.getElementById('editGooglechat').checked = hasGooglechat;
            
            const modal = document.getElementById('editModal');
            modal.classList.add('active');
        }
        
        // Fechar modal de edição
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditingTicket = null;
        }
        
        // Confirmar edição
        function confirmEdit() {
            const ticket = tickets.find(t => t.id === currentEditingTicket);
            if (!ticket) return;
            
            const newNumber = document.getElementById('editTicketNumber').value.trim();
            const newClient = document.getElementById('editClientName').value.trim();
            const newDescription = document.getElementById('editDescription').value.trim();
            
            if (!newNumber || !newClient) {
                alert('Preencha o número do chamado e nome do cliente!');
                return;
            }
            
            // Verificar canais selecionados
            const channels = [];
            if (document.getElementById('editWhatsapp').checked) 
                channels.push('<img src="icons/whatsapp.png" alt="WhatsApp" style="width: 14px; height: 14px;">');
            if (document.getElementById('editSlack').checked) 
                channels.push('<img src="icons/slack.png" alt="Slack" style="width: 14px; height: 14px;">');
            if (document.getElementById('editGooglechat').checked) 
                channels.push('<img src="icons/google-chat.png" alt="Google Chat" style="width: 14px; height: 14px;">');
            
            if (channels.length === 0) {
                alert('Selecione pelo menos um canal de contato!');
                return;
            }
            
            // Atualizar ticket
            ticket.number = newNumber;
            ticket.client = newClient;
            ticket.description = newDescription;
            ticket.channels = channels;
            
            saveData();
            updateDisplay();
            closeEditModal();
        }
        
        // Iniciar timer para o chamado
        function startTimer(ticket) {
            if (timers[ticket.id]) {
                clearInterval(timers[ticket.id]);
            }
            
            timers[ticket.id] = setInterval(() => {
                checkTicketStatus(ticket);
            }, 1000);
        }
        
        // Verificar status do chamado
        function checkTicketStatus(ticket) {
            const now = new Date();
            const lastAction = new Date(ticket.lastAction);
            const diffMinutes = Math.floor((now - lastAction) / 1000 / 60);
            const waitTime = ticket.waitTime || 30;
            
            // Chamado agendado
            if (ticket.status === 'agendado' && ticket.scheduledFor) {
                const scheduledTime = new Date(ticket.scheduledFor);
                if (now >= scheduledTime) {
                    showNotification(
                        'Chamado Agendado!',
                        `Hora de atender o chamado ${ticket.number} - ${ticket.client}`,
                        ticket.id
                    );
                    ticket.status = 'atendendo';
                    ticket.lastAction = now.toISOString();
                    saveData();
                    updateDisplay();
                }
                return;
            }
            
            // Chamado pausado aguardando 72h
            if (ticket.status === 'pausado' && !ticket.waitingSupplier) {
                const pausedAt = new Date(ticket.pausedAt);
                const workDays = getWorkDaysDiff(pausedAt, now);
                
                if (workDays >= 3) {
                    showNotification(
                        'Encerrar Chamado',
                        `Chamado ${ticket.number} - ${ticket.client} pode ser encerrado (72h úteis sem resposta)`,
                        ticket.id
                    );
                }
                return;
            }
            
            // Chamado em acompanhamento (Bloqueio Constante - 2 dias após correção)
            if (ticket.status === 'acompanhamento' && ticket.bloqueioConstante && ticket.fixedAt) {
                const fixedAt = new Date(ticket.fixedAt);
                const workDays = getWorkDaysDiff(fixedAt, now);
                
                if (workDays >= 2) {
                    showNotification(
                        'Acompanhamento Concluído',
                        `Chamado ${ticket.number} - ${ticket.client} pode ser encerrado (2 dias de acompanhamento)`,
                        ticket.id
                    );
                }
                return;
            }
            
            // Primeiro contato (após tempo configurado)
            if (ticket.status === 'novo' && diffMinutes >= waitTime) {
                const channelName = ticket.channels[0].includes('whatsapp') ? 'WhatsApp' : 
                                   ticket.channels[0].includes('slack') ? 'Slack' : 
                                   ticket.channels[0].includes('google-chat') ? 'Google Chat' : 'Canal';
                showNotification(
                    'Primeiro Contato Necessário!',
                    `Envie mensagem via ${channelName} para ${ticket.client} - Chamado ${ticket.number}`,
                    ticket.id
                );
            }
            
            // Contatos subsequentes
            if (ticket.status.startsWith('contato')) {
                if (diffMinutes >= waitTime) {
                    const channelIndex = parseInt(ticket.status.replace('contato', ''));
                    if (channelIndex < ticket.channels.length) {
                        const channelName = ticket.channels[channelIndex].includes('whatsapp') ? 'WhatsApp' : 
                                           ticket.channels[channelIndex].includes('slack') ? 'Slack' : 
                                           ticket.channels[channelIndex].includes('google-chat') ? 'Google Chat' : 'Canal';
                        showNotification(
                            `${channelIndex + 1}º Tentativa de Contato`,
                            `Envie mensagem via ${channelName} para ${ticket.client} - Chamado ${ticket.number}`,
                            ticket.id
                        );
                    } else {
                        showNotification(
                            'Pausar Chamado',
                            `Todas as tentativas realizadas. Pause o chamado ${ticket.number} - ${ticket.client}`,
                            ticket.id
                        );
                    }
                }
            }
            
            updateDisplay();
        }
        
        // Calcular dias úteis
        function getWorkDaysDiff(startDate, endDate) {
            let count = 0;
            let curDate = new Date(startDate);
            curDate.setDate(curDate.getDate() + 1); // Start from the next day
            
            while (curDate < endDate) { // Use < instead of <= to exclude end date
                const dayOfWeek = curDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) count++;
                curDate.setDate(curDate.getDate() + 1);
            }
            
            return count;
        }
        
        // Confirmar envio de mensagem
        function confirmContact(ticketId, channelIndex) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            // Clear alerts for this ticket
            alertedTickets.forEach(alertKey => {
                if (alertKey.startsWith(ticketId)) {
                    alertedTickets.delete(alertKey);
                }
            });
            stopContinuousAlert();
            
            // Incrementar para o próximo canal
            const nextChannelIndex = channelIndex + 1;
            
            // Atualizar status e contador
            ticket.status = `contato${nextChannelIndex}`;
            ticket.lastAction = new Date().toISOString();
            ticket.contactAttempts = nextChannelIndex;
            
            saveData();
            updateDisplay();
        }
        
        // Cliente respondeu
        function clientResponded(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            // Clear alerts for this ticket
            alertedTickets.forEach(alertKey => {
                if (alertKey.startsWith(ticketId)) {
                    alertedTickets.delete(alertKey);
                }
            });
            stopContinuousAlert();
            
            ticket.status = 'atendendo';
            ticket.lastAction = new Date().toISOString();
            
            saveData();
            updateDisplay();
        }
        
        // Pausar chamado
        function pauseTicket(ticketId, waitingSupplier = false) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            ticket.status = waitingSupplier ? 'fornecedor' : 'pausado';
            ticket.pausedAt = new Date().toISOString();
            ticket.waitingSupplier = waitingSupplier;
            
            saveData();
            updateDisplay();
        }
        
        // Retomar chamado
        function resumeTicket(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            ticket.status = 'atendendo';
            ticket.lastAction = new Date().toISOString();
            ticket.pausedAt = null;
            ticket.waitingSupplier = false;
            
            saveData();
            updateDisplay();
        }
        
        // Marcar como corrigido (apenas para Bloqueio Constante)
        function markFixed(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket || !ticket.bloqueioConstante) return;
            
            if (!confirm(`Confirma que o problema do chamado ${ticket.number} foi corrigido? Será iniciado um acompanhamento de 2 dias.`)) return;
            
            ticket.status = 'acompanhamento';
            ticket.fixedAt = new Date().toISOString();
            ticket.followUpDays = 0;
            ticket.lastAction = new Date().toISOString();
            
            saveData();
            updateDisplay();
        }
        
        // Relatar problema durante acompanhamento
        function reportIssue(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket || !ticket.bloqueioConstante) return;
            
            if (!confirm(`Relatar problema no chamado ${ticket.number}? O chamado voltará para atendimento.`)) return;
            
            ticket.status = 'atendendo';
            ticket.fixedAt = null;
            ticket.followUpDays = 0;
            ticket.lastAction = new Date().toISOString();
            
            saveData();
            updateDisplay();
        }
        
        // Fechar chamado
        function closeTicket(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            if (!confirm(`Confirma o fechamento do chamado ${ticket.number}?`)) return;
            
            ticket.status = 'fechado';
            ticket.closedAt = new Date().toISOString();
            
            if (timers[ticketId]) {
                clearInterval(timers[ticketId]);
                delete timers[ticketId];
            }
            
            saveData();
            updateDisplay();
        }
        
        // Excluir chamado
        function deleteTicket(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            if (!confirm(`Tem certeza que deseja EXCLUIR PERMANENTEMENTE o chamado ${ticket.number}?\n\nEsta ação não pode ser desfeita!`)) return;
            
            // Remover timer se existir
            if (timers[ticketId]) {
                clearInterval(timers[ticketId]);
                delete timers[ticketId];
            }
            
            // Remover alertas para este ticket
            alertedTickets.forEach(alertKey => {
                if (alertKey.startsWith(ticketId)) {
                    alertedTickets.delete(alertKey);
                }
            });
            
            // Remover ticket da lista
            const ticketIndex = tickets.findIndex(t => t.id === ticketId);
            if (ticketIndex !== -1) {
                tickets.splice(ticketIndex, 1);
            }
            
            saveData();
            updateDisplay();
        }
        
        // Reconhecer alerta
        function acknowledgeAlert(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            ticket.lastAction = new Date().toISOString();
            // Clear alerts for this ticket
            alertedTickets.forEach(alertKey => {
                if (alertKey.startsWith(ticketId)) {
                    alertedTickets.delete(alertKey);
                }
            });
            stopContinuousAlert();
            saveData();
        }
        
        // Atualizar exibição
        function updateDisplay() {
            const container = document.getElementById('ticketsContainer');
            const openTickets = tickets.filter(t => t.status !== 'fechado');
            
            // Atualizar estatísticas
            document.getElementById('totalTickets').textContent = openTickets.length;
            document.getElementById('activeTickets').textContent = openTickets.filter(t => t.status === 'atendendo').length;
            document.getElementById('pausedTickets').textContent = openTickets.filter(t => t.status === 'pausado' || t.status === 'fornecedor').length;
            document.getElementById('scheduledTickets').textContent = openTickets.filter(t => t.status === 'agendado').length;
            
            // Group tickets by status
            const statusGroups = {
                'atendendo': [],
                'novo': [],
                'contato': [],
                'pausado': [],
                'fornecedor': [],
                'agendado': [],
                'bloqueio_constante': [],
                'acompanhamento': []
            };
            
            openTickets.forEach(ticket => {
                let groupKey = ticket.status;
                
                // Group contact statuses together
                if (ticket.status.startsWith('contato')) {
                    groupKey = 'contato';
                }
                
                // Only put in bloqueio_constante group if status is acompanhamento AND it's bloqueio constante
                if (ticket.bloqueioConstante && ticket.status === 'acompanhamento') {
                    groupKey = 'bloqueio_constante';
                }
                
                if (statusGroups[groupKey]) {
                    statusGroups[groupKey].push(ticket);
                }
            });
            
            const statusGroupNames = {
                'atendendo': '🔧 Em Atendimento',
                'novo': '🆕 Novos',
                'contato': '📞 Em Contato',
                'pausado': '⏸️ Pausados',
                'fornecedor': '🏢 Aguardando Fornecedor',
                'agendado': '📅 Agendados',
                'bloqueio_constante': '🔒 Bloqueio Constante',
                'acompanhamento': '👀 Em Acompanhamento'
            };
            
            // Define order of sections
            const statusOrder = [
                'atendendo',
                'novo', 
                'contato',
                'pausado',
                'fornecedor',
                'agendado',
                'bloqueio_constante',
                'acompanhamento'
            ];
            
            let allTablesHTML = '';
            
            statusOrder.forEach(status => {
                const tickets = statusGroups[status];
                if (tickets && tickets.length > 0) {
                    // Create separate table for each section
                    allTablesHTML += `
                        <div class="section-container" style="margin-bottom: 30px;">
                            <div class="section-header" style="background: #e3f2fd; padding: 12px; border-radius: 8px 8px 0 0; text-align: center; font-weight: 600; color: #1565c0; font-size: 0.9rem; letter-spacing: 0.5px;">
                                ${statusGroupNames[status]} (${tickets.length})
                            </div>
                            <table class="tickets-table" style="border-radius: 0 0 8px 8px; overflow: hidden;">
                                <thead>
                                    <tr>
                                        <th>Chamado</th>
                                        <th>Cliente</th>
                                        <th>Status</th>
                                        <th>Descrição</th>
                                        <th>Canais</th>
                                        <th>Timer</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Add tickets for this group
                    tickets.forEach(ticket => {
                const now = new Date();
                const lastAction = new Date(ticket.lastAction);
                const diffMinutes = Math.floor((now - lastAction) / 1000 / 60);
                const waitTime = ticket.waitTime || 30;
                const shouldAlert = (ticket.status === 'novo' && diffMinutes >= waitTime) ||
                                  (ticket.status.startsWith('contato') && diffMinutes >= waitTime);
                
                let timerText = '';
                if (ticket.status === 'agendado' && ticket.scheduledFor) {
                    const scheduled = new Date(ticket.scheduledFor);
                    if (scheduled > now) {
                        const diff = scheduled - now;
                        const hours = Math.floor(diff / 1000 / 60 / 60);
                        const minutes = Math.floor((diff / 1000 / 60) % 60);
                        timerText = `Agendado para: ${hours}h ${minutes}min`;
                    } else {
                        timerText = '⚠️ HORA DE ATENDER!';
                    }
                } else if (ticket.status === 'pausado' && !ticket.waitingSupplier) {
                    const pausedAt = new Date(ticket.pausedAt);
                    const workDays = getWorkDaysDiff(pausedAt, now);
                    timerText = `Pausado há ${workDays} dias úteis (máx: 3)`;
                } else if (ticket.status === 'fornecedor') {
                    timerText = 'Aguardando fornecedor';
                } else if (ticket.status === 'acompanhamento' && ticket.fixedAt) {
                    const fixedAt = new Date(ticket.fixedAt);
                    const workDays = getWorkDaysDiff(fixedAt, now);
                    const remaining = 2 - workDays;
                    timerText = remaining > 0 ? `Acompanhamento: ${remaining} dias restantes` : '⚠️ ACOMPANHAMENTO CONCLUÍDO!';
                } else if (ticket.status !== 'fechado' && ticket.status !== 'atendendo' && ticket.status !== 'acompanhamento') {
                    const remaining = waitTime - diffMinutes;
                    if (remaining > 0) {
                        timerText = `Próxima ação em: ${remaining} min`;
                    } else {
                        timerText = '⚠️ AÇÃO NECESSÁRIA!';
                    }
                }
                
                let statusClass = 'status-' + ticket.status.replace(/\d/g, '');
                
                // Determinar qual canal deve ser usado
                const currentChannelIndex = ticket.status.startsWith('contato') ? 
                    parseInt(ticket.status.replace('contato', '')) - 1 : -1;
                const nextChannelIndex = currentChannelIndex + 1;
                const hasMoreChannels = nextChannelIndex < ticket.channels.length;
                const canPause = !hasMoreChannels && ticket.status.startsWith('contato') && diffMinutes >= waitTime;
                
                allTablesHTML += `
                        <tr class="ticket-row ${shouldAlert ? 'alert' : ''}">
                            <td>
                                <button class="btn-delete" onclick="deleteTicket('${ticket.id}')" title="Excluir chamado">
                                    ❌
                                </button>
                                ${ticket.link ? 
                                    `<a href="${ticket.link}" target="_blank" class="ticket-number" style="color: #667eea; text-decoration: none;">${ticket.number}</a>` : 
                                    `<span class="ticket-number">${ticket.number}</span>`
                                }
                            </td>
                            <td>${ticket.client}</td>
                            <td>
                                <span class="ticket-status ${statusClass}">${ticket.status}</span>
                            </td>
                            <td>
                                ${ticket.description || 'Sem descrição'}
                                ${ticket.bloqueioConstante ? '<span class="bloqueio-constante-badge">BLOQUEIO CONSTANTE</span>' : ''}<br>
                                <small style="color: #999;">Tentativas: ${ticket.contactAttempts}/${ticket.channels.length}</small>
                                ${ticket.scheduleNotes ? `<br><small style="color: #999;">${ticket.scheduleNotes}</small>` : ''}
                            </td>
                            <td>${ticket.channels.join(' ')}</td>
                            <td>
                                ${timerText ? `<span class="timer-text">${timerText}</span>` : ''}
                            </td>
                            <td>
                                <div class="ticket-actions">
                            ${ticket.status === 'novo' ? `
                                <button class="btn-warning" onclick="confirmContact('${ticket.id}', 0)">
                                    ✓ Enviado ${ticket.channels[0]}
                                </button>
                            ` : ''}
                            ${ticket.status.startsWith('contato') ? (
                                canPause ? `
                                    <button class="btn-secondary" onclick="pauseTicket('${ticket.id}')">
                                        Pausar Chamado
                                    </button>
                                ` : hasMoreChannels ? `
                                    <button class="btn-warning" onclick="confirmContact('${ticket.id}', ${nextChannelIndex})">
                                        ✓ Enviado ${ticket.channels[nextChannelIndex]}
                                    </button>
                                ` : ''
                            ) : ''}
                            ${(ticket.status !== 'atendendo' && ticket.status !== 'fechado' && 
                               ticket.status !== 'fornecedor' && ticket.status !== 'pausado' && 
                               ticket.status !== 'agendado') ? `
                                <button class="btn-success" onclick="clientResponded('${ticket.id}')">
                                    Cliente Respondeu
                                </button>
                            ` : ''}
                            ${ticket.status === 'atendendo' ? `
                                <button class="btn-secondary" onclick="pauseTicket('${ticket.id}')">
                                    Pausar
                                </button>
                                <button class="btn-warning" onclick="pauseTicket('${ticket.id}', true)">
                                    Aguardar Fornecedor
                                </button>
                                <button style="background: #9c27b0" onclick="openScheduleModal('${ticket.id}')">
                                    📅 Agendar
                                </button>
                                ${ticket.bloqueioConstante ? `
                                    <button style="background: #4caf50" onclick="markFixed('${ticket.id}')">
                                        ✅ Corrigido
                                    </button>
                                ` : ''}
                                <button class="btn-success" onclick="closeTicket('${ticket.id}')">
                                    Fechar Chamado
                                </button>
                            ` : ''}
                            ${(ticket.status === 'pausado' || ticket.status === 'fornecedor') ? `
                                <button class="btn-success" onclick="resumeTicket('${ticket.id}')">
                                    Retomar
                                </button>
                                <button style="background: #9c27b0" onclick="openScheduleModal('${ticket.id}')">
                                    📅 Agendar
                                </button>
                                <button class="btn-danger" onclick="closeTicket('${ticket.id}')">
                                    Fechar
                                </button>
                            ` : ''}
                            ${ticket.status === 'agendado' ? `
                                <button class="btn-success" onclick="clientResponded('${ticket.id}')">
                                    Iniciar Atendimento
                                </button>
                                <button class="btn-danger" onclick="closeTicket('${ticket.id}')">
                                    Cancelar
                                </button>
                            ` : ''}
                            ${ticket.status === 'acompanhamento' ? `
                                <button class="btn-warning" onclick="reportIssue('${ticket.id}')">
                                    Relatar Problema
                                </button>
                                <button class="btn-success" onclick="closeTicket('${ticket.id}')">
                                    Finalizar Acompanhamento
                                </button>
                            ` : ''}
                                    <button class="btn-edit" onclick="openEditModal('${ticket.id}')" title="Editar chamado">
                                        ✏️
                                    </button>
                                </div>
                            </td>
                        </tr>
                `;
                    });
                    
                    // Close this table
                    allTablesHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = openTickets.length > 0 ? 
                allTablesHTML : 
                '<div style="display: flex; align-items: center; justify-content: center; height: 140px; color: #666; font-size: 1rem;">Nenhum chamado ativo</div>';
        }
        
        // Monitorar mudança no tipo de chamado
        document.getElementById('ticketType').addEventListener('change', function() {
            const scheduleGroup = document.getElementById('scheduleGroup');
            if (this.value === 'scheduled') {
                scheduleGroup.style.display = 'block';
                // Definir data/hora mínima como agora
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('scheduleDateTime').min = now.toISOString().slice(0, 16);
            } else {
                scheduleGroup.style.display = 'none';
            }
        });
        
        // Toggle formulário de novo chamado
        function toggleNewTicketForm() {
            const form = document.getElementById('newTicketForm');
            const icon = document.getElementById('newTicketIcon');
            
            if (form.classList.contains('active')) {
                form.classList.remove('active');
                icon.textContent = '+';
            } else {
                form.classList.add('active');
                icon.textContent = '-';
            }
        }
        
        // Carregar dados ao iniciar
        loadData();
        
        // Atualizar display a cada 30 segundos
        setInterval(updateDisplay, 30000);
    </script>

    <footer>
        <p>&copy; 2025 | @cadux64 - Todos os direitos reservados.</p>
    </footer>
</body>
</html>